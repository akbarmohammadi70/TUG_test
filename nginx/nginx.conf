worker_processes auto;
events { worker_connections 1024; }
http {
sendfile on;
tcp_nopush on;
tcp_nodelay on;
keepalive_timeout 65;
types_hash_max_size 2048;


include /etc/nginx/mime.types;
default_type application/octet-stream;


# gzip
gzip on;
gzip_disable "msie6";
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;


# proxy cache
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m max_size=100m inactive=60m use_temp_path=off;


server {
listen 80;
server_name _;


# frontend (Next.js)
location / {
proxy_pass http://frontend:3000;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;


# Cache assets aggressively
proxy_cache STATIC;
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;
add_header X-Proxy-Cache $upstream_cache_status;
}


# backend api
location /api/ {
proxy_pass http://backend:3001;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;


# Do not cache POST/PUT/DELETE
proxy_cache STATIC;
proxy_cache_bypass $http_cache_control;
proxy_cache_valid 200 30s; # short caching for GET responses
add_header X-Proxy-Cache $upstream_cache_status;
}
}
}